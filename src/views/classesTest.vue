<template>
  <div class="book-section">
    <div v-if="isAnimating" class="blocking-overlay"></div>

    <div 
      class="book" 
      ref="bookRef"
      :class="{ 'intro-center-pos': isIntroPosition }"
    >
      
      <div class="page cover">
        <div class="page-content">
          <h1>å°ç£é­”æ³•å­¸é™¢</h1>
          <p>Taiwan Magic Academy</p>
          <div class="decoration">âœ¨</div>
          <p class="hint">
            <span v-if="isAnimating">æ­£åœ¨æ–½æ³•ä¸­...</span>
            <span v-else>è«‹æ‹–æ›³æ›¸è§’æˆ–é›™æ“Šç¿»é </span>
          </p>
        </div>
      </div>

      <div class="page">
        <div class="page-content text-page">
          <h3>é™¢é•·è‡´è©</h3>
          <p>æ­¡è¿ä¾†åˆ°é€™ç‰‡å……æ»¿å¥‡è¹Ÿçš„åœŸåœ°ã€‚åœ¨é€™è£¡ï¼Œç¨‹å¼ç¢¼æ˜¯å’’èªï¼Œç€è¦½å™¨æ˜¯æˆ‘å€‘çš„é­”æ–ã€‚</p>
          <p>è«‹å°å¿ƒç¿»é–±ï¼ŒçŸ¥è­˜æ˜¯æœ‰é‡é‡çš„ã€‚</p>
          
          <button class="nav-btn" @click.stop="goToPage(10)">
            ğŸš€ å‚³é€è‡³è£å‚™å€
          </button>
        </div>
      </div>

      <div class="page">
        <div class="page-content">
          <h3>é­”è—¥å­¸ï¼šVue Composition</h3>
          <p>å°‡ `ref` èˆ‡ `reactive` æ··åˆæ”ªæ‹Œï¼Œä¸¦åŠ å…¥ä¸€é» `computed` çš„ç²¾è¯ã€‚</p>
          <div class="potion-image-box">ğŸ§ª</div>
          <p class="caption">åŸºç¤é…æ–¹ï¼šSetup Sugar</p>
        </div>
      </div>

      <div class="page">
        <div class="page-content">
          <h3>å­¸é™¢åœ°åœ–</h3>
          <ul class="magic-list">
            <li>ğŸ° <strong>å‰ç«¯å ¡å£˜</strong> (Main Hall)</li>
            <li>ğŸŒ² <strong>å¾Œç«¯é»‘æ£®æ—</strong> (Backend API)</li>
            <li>ğŸ“š <strong>è³‡æ–™åº«åœ–æ›¸é¤¨</strong> (MySQL)</li>
            <li>âš”ï¸ <strong>Git ç«¶æŠ€å ´</strong> (Version Control)</li>
          </ul>
        </div>
      </div>

      <div class="page">
        <div class="page-content">
          <h3>å’’èªå­¸ï¼šAPI å¬å–šè¡“</h3>
          <div class="code-block">
            <span class="keyword">await</span> axios.<span class="func">get</span>(<span class="str">'/magic'</span>);
          </div>
          <p>æ®å‹•ä½ çš„ Axios é­”æ–ï¼Œå¾é™é çš„ä¼ºæœå™¨å¬å–šæ•¸æ“šç²¾éˆã€‚</p>
          <hr class="divider">
          <p class="small-text">âš ï¸ è­¦å‘Šï¼šè‹¥é­”åŠ›ä¸è¶³ (404)ï¼Œç²¾éˆå°‡æ‹’çµ•å›æ‡‰ã€‚</p>
        </div>
      </div>

      <div class="page">
        <div class="page-content">
          <h3>å¥‡ç¸é£¼è‚²å­¸</h3>
          <div class="creature-card">
            <div class="creature-icon">ğŸ•·ï¸</div>
            <h4>åç¨±ï¼šåƒå¹´ Bug</h4>
            <p><strong>ç¿’æ€§ï¼š</strong>ç¸½æ˜¯åœ¨ Demo å‰ä¸€åˆ»å‡ºç¾ï¼Œå–œæ­¡èº²åœ¨éåŒæ­¥å‡½å¼ä¸­ã€‚</p>
            <p><strong>å‰‹æ˜Ÿï¼š</strong>Chrome DevTools èˆ‡ console.log æ³•é™£ã€‚</p>
          </div>
        </div>
      </div>

      <div class="page">
        <div class="page-content">
          <h3>å åœå­¸ï¼šæœªä¾†ä¹‹è·¯</h3>
          <p>é€éæ°´æ™¶çƒçªºæ¢ç•¢æ¥­å¾Œçš„å‘½é‹...</p>
          <ul class="prophecy-list">
            <li>ğŸ”® <strong>å…¨ç«¯å¤§æ³•å¸«</strong> (Full Stack)</li>
            <li>ğŸ¨ <strong>UI å¹»è¡“å¸«</strong> (Designer)</li>
            <li>ğŸ›¡ï¸ <strong>è³‡å®‰å®ˆè­·è€…</strong> (Security)</li>
          </ul>
          <p>å‘½é‹æŒæ¡åœ¨ä½ çš„ Commit ç´€éŒ„ä¸­ã€‚</p>
        </div>
      </div>

      <div class="page">
        <div class="page-content">
          <h3>ç¦å¿Œæ£®æ—å…¥å£</h3>
          <p>å‰æ–¹åµæ¸¬åˆ°å¼·å¤§çš„é­”åŠ›æ³¢å‹•...</p>
          <div class="game-portal-icon">ğŸŒ€</div>
          <router-link to="/parallax-test" class="magic-btn">
            é€²å…¥éŠæˆ²æ¸¬è©¦
          </router-link>
          <p class="small-text">é»æ“ŠæŒ‰éˆ•é€²è¡Œç©ºé–“è·³èº</p>
        </div>
      </div>

      <div class="page">
        <div class="page-content image-page">
           <img src="https://picsum.photos/300/400?grayscale" alt="Old Library" />
        </div>
      </div>

      <div class="page">
          <div class="page-content">
              <h3>é­”æ³•ç­†è¨˜</h3>
              <p>é€™è£¡è¨˜éŒ„è‘—æœªçŸ¥çš„ç¬¦æ–‡...</p>
          </div>
      </div>

      <div class="page">
        <div class="page-content equipment-page">
           <h3>å†’éšªè€…è£å‚™æ¬„</h3>
           <button class="nav-btn back-btn" @click.stop="goToPage(3)">
             â¬…ï¸ å›åˆ°å­¸é™¢åœ°åœ–
           </button>
           <p>è«‹å¾å³å´èƒŒåŒ…æ‹–æ›³è£å‚™è‡³æ­¤</p>
           
           <div 
             class="equipment-slot" 
             :class="{ 'has-item': equippedItem }"
             @dragover.prevent 
             @drop="onDrop"
           >
              <div v-if="equippedItem" class="equipped-icon">{{ equippedItem }}</div>
              <div v-else class="placeholder-text">
                <span style="font-size: 2rem; opacity: 0.3;">ğŸ›¡ï¸</span>
                <p>æ‹–æ›³è‡³æ­¤è£å‚™</p>
              </div>
           </div>

           <p class="equip-status" v-if="equippedItem">
             å·²è£å‚™: <strong>{{ getEquipName(equippedItem) }}</strong>
           </p>

           <img src="https://picsum.photos/300/200?grayscale&blur=2" class="bg-img" />
        </div>
      </div>

      <div class="page">
          <div class="page-content">
              <h3>èƒŒåŒ…</h3>
              <div class="inventory-grid" style="display:flex; gap:10px; flex-wrap:wrap; justify-content:center; margin-top:20px;">
                  <div class="item" draggable="true" @dragstart="startDrag($event, 'ğŸ—¡ï¸')" style="font-size:3rem; cursor:grab;">ğŸ—¡ï¸</div>
                  <div class="item" draggable="true" @dragstart="startDrag($event, 'ğŸ·')" style="font-size:3rem; cursor:grab;">ğŸ·</div>
                  <div class="item" draggable="true" @dragstart="startDrag($event, 'ğŸ“œ')" style="font-size:3rem; cursor:grab;">ğŸ“œ</div>
                  <div class="item" draggable="true" @dragstart="startDrag($event, 'ğŸ—ºï¸')" style="font-size:3rem; cursor:grab;">ğŸ—ºï¸</div>
              </div>
          </div>
      </div>

      <div class="page">
        <div class="page-content">
          <h3>è§’è‰²ç‹€æ…‹</h3>
          <div class="profile-box">
              <div class="avatar">ğŸ§™â€â™‚ï¸</div>
              <h4>Level 5 è¦‹ç¿’å·«å¸«</h4>
          </div>
          
          <div class="stat-bars">
            <div class="stat-row">
              <span>HP</span>
              <div class="bar-container"><div class="bar red" style="width: 80%"></div></div>
            </div>
            <div class="stat-row">
              <span>MP</span>
              <div class="bar-container"><div class="bar blue" style="width: 45%"></div></div>
            </div>
            <div class="stat-row">
              <span>EXP</span>
              <div class="bar-container"><div class="bar green" style="width: 30%"></div></div>
            </div>
          </div>
        </div>
      </div>

      <div class="page">
        <div class="page-content">
        </div>
      </div>

      <div class="page">
        <div class="page-content">
        </div>
      </div>

      <div class="page cover">
        <div class="page-content">
          <h3>The End</h3>
          <p>Â© 2025 Class Project</p>
        </div>
      </div>

    </div>
  </div>
</template>

<script setup>
import { onMounted, onUnmounted, ref } from 'vue';
import { PageFlip } from 'page-flip';
// è«‹ç¢ºèªé€™äº›å…ƒä»¶çš„è·¯å¾‘æ˜¯å¦æ­£ç¢º

const bookRef = ref(null);
const isAnimating = ref(true); // é–å®šäº’å‹•
// ğŸ”¥ æ–°å¢ï¼šæ§åˆ¶æ›¸æœ¬èµ·å§‹ä½ç½® (true = åœ¨ä¸­é–“, false = å›åˆ°æ­£å¸¸ä½ç½®)
const isIntroPosition = ref(true); 
// ğŸ“Š æ–°å¢ï¼šé é¢ç‹€æ…‹è¿½è¹¤
const currentPage = ref(0);
const totalPages = ref(0);
const FLIP_SPEEDS = {
  intro: 400,        // é–‹å ´å¿«é€Ÿç¿»é é–“éš”
  normal: 800,       // æ­£å¸¸ç¿»é å‹•ç•«æ™‚é•·
  coverClose: 1500,  // è“‹æ›¸å‹•ç•«æ™‚é•·
};

let pageFlip = null;

// --- è¼”åŠ©å‡½å¼ ---
const wait = (ms) => new Promise(resolve => setTimeout(resolve, ms));

const updatePageNumber = () => {
  if (!pageFlip) return;
  currentPage.value = pageFlip.getCurrentPageIndex();
  totalPages.value = pageFlip.getPageCount();
  
  console.log(`ğŸ“– ç•¶å‰é : ${currentPage.value + 1} / ç¸½é æ•¸: ${totalPages.value}`);
};

// --- é–‹å ´å‹•ç•«é‚è¼¯ ---
const playIntroAnimation = async () => {
  if (!pageFlip) return;

  await wait(800);
  isIntroPosition.value = false;
  await wait(1600);

  // ä½¿ç”¨è®Šæ•¸æ§åˆ¶ç¿»é é€Ÿåº¦
  for (let i = 0; i < totalPages.value/2; i++) {
    pageFlip.flipNext();
    await wait(FLIP_SPEEDS.intro);
  }

  await wait(FLIP_SPEEDS.coverClose);
  pageFlip.flip(0);
  await wait(FLIP_SPEEDS.coverClose);

  pageFlip.flip(1);
  await wait(600);
  
  isAnimating.value = false;
  updatePageNumber(); // å‹•ç•«çµæŸå¾Œæ›´æ–°é ç¢¼
};

// --- è·³é å‡½å¼ (åŠ å…¥é ç¢¼æ›´æ–°) ---
const goToPage = (pageNum) => {
  if (pageFlip && !isAnimating.value) {
    pageFlip.flip(pageNum);
    // ç¿»é å¾Œç¨å¾®å»¶é²æ›´æ–° (ç­‰å‹•ç•«å®Œæˆ)
    setTimeout(updatePageNumber, FLIP_SPEEDS.normal);
  }
};



// --- ğŸ’ æ‹–æ›³åŠŸèƒ½é‚è¼¯ ---
const equippedItem = ref(null);

const startDrag = (event, itemIcon) => {
  event.dataTransfer.dropEffect = 'copy';
  event.dataTransfer.effectAllowed = 'copy';
  event.dataTransfer.setData('item', itemIcon);
};

const onDrop = (event) => {
  const item = event.dataTransfer.getData('item');
  if (item) {
    equippedItem.value = item;
  }
};

const getEquipName = (icon) => {
  const map = { 'ğŸ—¡ï¸': 'Excalibur', 'ğŸ·': 'é˜¿å¬¤çš„è—¥æ°´', 'ğŸ“œ': 'Vue æ–‡ä»¶', 'ğŸ—ºï¸': 'è—å¯¶åœ–' };
  return map[icon] || 'æœªçŸ¥ç‰©å“';
};

onMounted(() => {
  pageFlip = new PageFlip(bookRef.value, {
    width: 400,
    height: 600,
    size: 'fixed',
    showCover: true,
    maxShadowOpacity: 0.2,
    flippingTime: FLIP_SPEEDS.normal, // ä½¿ç”¨è®Šæ•¸
  });

  pageFlip.loadFromHTML(bookRef.value.querySelectorAll('.page'));

  // ğŸ”¥ ç›£è½ç¿»é äº‹ä»¶ (è‡ªå‹•æ›´æ–°é ç¢¼)
  pageFlip.on('flip', (e) => {
    updatePageNumber();
  });

  // åˆå§‹åŒ–é ç¢¼
  totalPages.value = pageFlip.getPageCount();
  
  playIntroAnimation();
});

onUnmounted(() => {
  if (pageFlip) pageFlip.destroy();
});
</script>

<style scoped>
/* --- ğŸ”¥ ä¿®æ”¹é» 3: å®¹å™¨å…¨è¢å¹• --- */
.book-section {
  width: 100vw;   /* ä½”æ»¿å¯¬åº¦ */
  height: 100vh;  /* ä½”æ»¿é«˜åº¦ */
  display: flex;
  justify-content: center;
  align-items: center;
  background-color: #2c3e50;
  overflow: hidden; 
  user-select: none; 
  position: relative;
  box-sizing: border-box; /* é¿å… padding æ’å¤§ */
  padding: 0;
  margin: 0;
}

/* äº’å‹•é˜»æ“‹é®ç½© */
.blocking-overlay {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  z-index: 9999;
  cursor: wait; 
  background: rgba(0,0,0,0);
}

.book {
  
  filter: drop-shadow(0 20px 20px rgba(0, 0, 0, 0.5));
  /* ğŸ”¥ ä¿®æ”¹é» 4: å¢åŠ æ»‘å‹•çš„è½‰å ´æ•ˆæœ */
  transition: transform 1.5s cubic-bezier(0.2, 0.8, 0.2, 1);
}

/* ğŸ”¥ ä¿®æ”¹é» 5: èµ·å§‹ä½ç½®è¨­å®š
  é€™å€‹ class å­˜åœ¨æ™‚ï¼Œæ›¸æœ¬æœƒè¢«ä½ç§»ã€‚
  translateX çš„æ•¸å€¼ (-25%) æ˜¯ç‚ºäº†æŠŠåŸæœ¬åå³çš„æ›¸æ‹‰å›ä¸­é–“ã€‚
  ä½ å¯ä»¥è©¦è‘—èª¿æ•´é€™å€‹ % æ•¸ï¼Œç›´åˆ°å®ƒçœ‹èµ·ä¾†å®Œå…¨åœ¨æ­£ä¸­å¤®ã€‚
*/
.intro-center-pos {
  transform: translateX(-25%) scale(0.9); 
}

/* --- é é¢æ¨£å¼ (ä¿æŒä¸è®Š) --- */
.page {
  padding: 20px;
  background-color: #ccc;
  border: 1px solid #c2b5a3;
  overflow: hidden;
  transition: none !important; 
}

/* è®“èƒŒæ™¯æœ‰é»ç´™è³ªæ„Ÿ */
.page::before {
  content: '';
  position: absolute;
  top: 0; left: 0; width: 100%; height: 100%;
  background-image: url('https://www.transparenttextures.com/patterns/paper.png');
  opacity: 0.4;
  pointer-events: none;
}

.cover {
  background-color: #8b4513; 
  color: #e0d5c1;
  border: 2px solid #5e2f0d;
}

.page-content {
  height: 100%;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  text-align: center;
}

h1, h3, h4 {
  font-family: "Times New Roman", serif;
  margin-bottom: 10px;
  color: #4a3b2a;
}
.cover h1, .cover h3 { color: #e0d5c1; }

.decoration { font-size: 2rem; margin: 10px 0; }
.hint { font-size: 0.8rem; opacity: 0.8; }
.magic-list { text-align: left; list-style: none; padding: 0; margin-top: 20px; font-family: 'Courier New', Courier, monospace; }
.magic-list li { margin-bottom: 15px; font-size: 1.1rem; border-bottom: 1px dashed #c2b5a3; padding-bottom: 5px; }
.potion-image-box { font-size: 4rem; margin: 20px 0; filter: drop-shadow(0 0 10px rgba(100, 200, 100, 0.5)); }
img { max-width: 100%; border-radius: 4px; box-shadow: 2px 2px 5px rgba(0,0,0,0.2); }
.code-block { background: #282c34; color: #abb2bf; padding: 15px; border-radius: 5px; font-family: 'Courier New', monospace; margin: 20px 0; box-shadow: inset 0 0 10px #000; text-align: left; width: 90%; }
.keyword { color: #c678dd; } .func { color: #61afef; } .str { color: #98c379; }
.divider { width: 50%; border-top: 1px solid #c2b5a3; margin: 20px 0; }
.small-text { font-size: 0.8rem; color: #888; }
.creature-card { border: 2px dashed #8b4513; padding: 15px; border-radius: 10px; background: rgba(139, 69, 19, 0.05); }
.creature-icon { font-size: 3rem; margin-bottom: 10px; }
.prophecy-list { list-style: none; padding: 0; margin: 20px 0; text-align: left; }
.prophecy-list li { font-size: 1.2rem; margin-bottom: 10px; padding: 5px; border-bottom: 1px solid rgba(0,0,0,0.1); }
.magic-btn { display: inline-block; margin-top: 15px; padding: 12px 24px; background: #8b4513; color: #fff; text-decoration: none; border-radius: 30px; border: 2px solid #e0d5c1; font-family: "Times New Roman", serif; font-weight: bold; letter-spacing: 1px; box-shadow: 0 4px 6px rgba(0,0,0,0.3); transition: all 0.3s ease; cursor: pointer; position: relative; z-index: 10; }
.magic-btn:hover { background: #a0522d; transform: scale(1.1) translateY(-2px); box-shadow: 0 0 15px rgba(255, 215, 0, 0.6); }
.magic-btn:active { transform: scale(0.95); }
.game-portal-icon { font-size: 4rem; margin: 15px 0; animation: spinPortal 3s linear infinite; }
@keyframes spinPortal { 0% { transform: rotate(0deg) scale(1); filter: hue-rotate(0deg); } 50% { transform: rotate(180deg) scale(1.1); filter: hue-rotate(90deg); } 100% { transform: rotate(360deg) scale(1); filter: hue-rotate(0deg); } }

.profile-box { margin-bottom: 20px; }
.avatar { font-size: 4rem; background: #eee; width: 100px; height: 100px; line-height: 100px; border-radius: 50%; margin: 0 auto 10px; border: 4px double #8b4513; }
.stat-bars { width: 100%; padding: 0 10px; }
.stat-row { display: flex; align-items: center; margin-bottom: 10px; gap: 10px; }
.stat-row span { width: 40px; font-weight: bold; font-family: monospace; }
.bar-container { flex-grow: 1; height: 15px; background: #ddd; border-radius: 10px; overflow: hidden; box-shadow: inset 0 1px 3px rgba(0,0,0,0.2); }
.bar { height: 100%; border-radius: 10px; }
.bar.red { background: linear-gradient(90deg, #ff6b6b, #e74c3c); }
.bar.blue { background: linear-gradient(90deg, #4facfe, #00f2fe); }
.bar.green { background: linear-gradient(90deg, #4cd964, #2ecc71); }

.equipment-page { position: relative; z-index: 1; }
.equipment-slot { width: 120px; height: 120px; margin: 20px auto; border: 3px dashed #8b4513; background: rgba(255, 255, 255, 0.8); border-radius: 10px; display: flex; justify-content: center; align-items: center; transition: all 0.3s; box-shadow: 0 0 15px rgba(0,0,0,0.1); }
.equipment-slot:hover { border-color: #d35400; background: rgba(255, 255, 255, 0.95); transform: scale(1.05); }
.has-item { border-style: solid; border-color: #27ae60; background: #fff; }
.equipped-icon { font-size: 4rem; animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
.placeholder-text { color: #aaa; font-size: 0.8rem; display: flex; flex-direction: column; align-items: center; }
.equip-status { background: rgba(0,0,0,0.7); color: #fff; padding: 5px 15px; border-radius: 20px; margin-top: 10px; }
.bg-img { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); width: 80%; opacity: 0.3; z-index: -1; pointer-events: none; }
@keyframes popIn { from { transform: scale(0); } to { transform: scale(1); } }

.nav-btn { margin-top: 20px; padding: 8px 16px; border: 2px solid #8b4513; background-color: #fff; color: #8b4513; font-family: "Times New Roman", serif; font-weight: bold; border-radius: 5px; cursor: pointer; transition: all 0.3s; z-index: 10; position: relative; }
.nav-btn:hover { background-color: #8b4513; color: #fff; transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
.back-btn { margin-top: 10px; background-color: rgba(255, 255, 255, 0.9); border-color: #2c3e50; color: #2c3e50; }
.back-btn:hover { background-color: #2c3e50; color: white; }
</style>